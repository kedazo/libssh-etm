Backport of:

From c2aed4ca78030d9014a890cb4370e6dc8264823f Mon Sep 17 00:00:00 2001
From: Jon Simons <jon@jonsimons.org>
Date: Sun, 19 Oct 2014 06:23:26 +0000
Subject: CVE-2014-8132: Fixup error path in ssh_packet_kexinit()

Before this change, dangling pointers can be unintentionally left in the
respective next_crypto kex methods slots.  Ensure to set all slots to
NULL in the error-out path.

Signed-off-by: Jon Simons <jon@jonsimons.org>
Reviewed-by: Andreas Schneider <asn@cryptomilk.org>
---
Index: libssh-0.6.3/src/kex.c
===================================================================
--- libssh-0.6.3.orig/src/kex.c	2015-01-07 11:59:20.072822104 -0500
+++ libssh-0.6.3/src/kex.c	2015-01-07 12:00:30.825361625 -0500
@@ -315,7 +315,7 @@
   for (i = 0; i < KEX_METHODS_SIZE; i++) {
     str = buffer_get_ssh_string(packet);
     if (str == NULL) {
-      break;
+      goto error;
     }
 
     if (buffer_add_ssh_string(session->in_hashbuf, str) < 0) {
@@ -350,6 +350,11 @@
 error:
   ssh_string_free(str);
   for (i = 0; i < SSH_KEX_METHODS; i++) {
+    if (server_kex) {
+        session->next_crypto->client_kex.methods[i] = NULL;
+    } else { /* client */
+        session->next_crypto->server_kex.methods[i] = NULL;
+    }
     SAFE_FREE(strings[i]);
   }
 
